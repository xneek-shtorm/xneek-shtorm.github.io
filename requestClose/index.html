<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Test for request close</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: "Comfortaa", sans-serif;
            font-optical-sizing: auto;
            font-style: normal;
        }

        h1, h2,h3,h4,h5,h6 {
            font-family: "Pacifico", cursive;
            font-weight: 400;
            font-style: normal;
        }



        #loaderDiv {
            height: 600px;
        }
    </style>
</head>
<body>

    <div class="d-flex justify-content-center" id="loaderDiv">
        <div class="spinner-border m-5" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>


    <div class="container d-none my-3" id="mainDiv">
        <div class="row">
          <div class="col">
            <h3>–î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
            <div id="requestDataPre"></div>
          </div>
          <div class="col border-left">
            <h3>–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ üò∂‚Äçüå´Ô∏è</h3>
            <div id="clientDataPre"></div>
          </div>
        </div>
        <form id="sampleForm" class="mt-3">
              <div class="mb-3">
                <label for="exampleFormControl" class="form-label">–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± —É—Å–ø–µ—Ö–µ –∏–ª–∏ –æ—à–∏–±–∫–µ</label>
                <input class="form-control" id="exampleFormControl" rows="3" required placeholder="–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞, –ª—é–±—ã–µ, –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫–∞">
              </div>
              <footer class="d-flex justify-content-between">
                <button type="reset" class="btn btn-danger">–°–ª–æ–≤–Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</button>
                <button type="submit" class="btn btn-success">–°–¥–µ–ª–∞—Ç—å —Ö–æ—Ä–æ—à–æ</button>
              </footer>
        </div>
    </div>
      



    <script>
        function postMessageListener(event) {
            // if (event.origin != 'http://ourTrustedDomain.ru') {
            //     // —á—Ç–æ-—Ç–æ –ø—Ä–∏—Å–ª–∞–ª–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ - –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º..
            //     return;
            // }

            const { action = null, payload = null } = JSON.parse(event.data);

            switch (action) {
                case 'ProductRequestChanged':

                    requestDataPre.innerHTML = [
                        ['–ó–∞–≥–æ–ª–æ–≤–æ–∫', payload.requestData.title],
                        ['–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π id', payload.requestData.id],
                        ['–í–Ω–µ—à–Ω–∏–π id', payload.requestData.externalId],
                        ['–ö–∞–Ω–∞–ª', payload.requestData.channelType],
                        ['–ê–¥—Ä–µ—Å', payload.requestData.originator],
                        ['–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', new Date(payload.requestData.timeRegistered).toLocaleString()],
                        ['–¢–µ–º–∞—Ç–∏–∫–∏', payload.requestSubjectLinks?.map(s => s.subjectName).join(' | ') ?? '-']
                    ].map(([k, v]) => `
                        <div class="row">
                            <div class="col-6 text-right text-muted">${k}</div>
                            <div class="col-6 text-warning">${v}</div>
                        </div>`
                    ).join('\n');


                    clientDataPre.innerHTML = [
                        ['–ò–º—è', payload.contactPersonsData[0].firstName],
                        ['–§–∞–º–∏–ª–∏—è', payload.contactPersonsData[0].lastName],
                    ].map(([k, v]) => `
                        <div class="row">
                            <div class="col-6 text-right text-muted">${k}</div>
                            <div class="col-6 text-right text-info">${v}</div>
                        </div>`
                    ).join('\n');

  
                    console.info('Received ProductRequestChanged event with data', payload);
                    break;

                default:
                    console.warn('Received not Product event', { action, payload })
            }
        }

        window.addEventListener("message", postMessageListener);

        // Sending

        const sendPostMessage = (str) => {
            if (window.parent) {
                window.parent.postMessage(str, document.referrer.length > 0 ? document.referrer : undefined);
                return;
            }
            window.postMessage(str);
            console.warn('Send post message', str);
        }

        const fakeLoadingTimeout = 2000;

        setTimeout(() => {
            loaderDiv.classList.add('d-none');; // hide loader

            const str = JSON.stringify({ action: 'ProductChildReady', payload: '' }, null, '  ');
            sendPostMessage(str);

            mainDiv.classList.remove('d-none');

        }, fakeLoadingTimeout);

        sampleForm.onsubmit = (e) => {
            e.preventDefault();
            const str = JSON.stringify({ action: 'ProductRequestActionProcessed', payload: exampleFormControl.value }, null, '  ');
            sendPostMessage(str);
        }

        sampleForm.onreset = (e) => {
            e.preventDefault();
            const str = JSON.stringify({ action: 'ProductRequestActionError', payload: exampleFormControl.value }, null, '  ');
            sendPostMessage(str);
        }

    </script>
</body>
</html>
